<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html dir="ltr" lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Security</title>
    <meta content="caterpillar" name="author">
    <meta content="JavaScript file iframe ajax the-same-origin-policy" name="keywords">
    <link href="css/std.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <div class="header">
      <div class="hgroup">
        <h3><a href="http://openhome.cc/eGossip/">From eGossip@Openhome</a></h3>
        <h1><a href="index.html">JavaScript Essence: Security<br>
          </a></h1>
      </div>
    </div>
    <div class="article">
      <div align="right"><a href="../../Gossip/JavaScript/SecurityConstraint.html">中文</a><br>
      </div>
      <br>
      JavaScript brings many security issues while running in a browser. Browsers download pages and execute JavaScript in the background. Some actions must be limited to prevent client data from being stolen, read or destroyed. Basically, browsers must prohibit JavaScript from accessing client files directly.<br>
      <br>
      However, there are still many considerable security issues. For instance, you can display a message in the status bar of the old browser; but this produces hidden troubles. In some conditions, one can fake a message in the status bar to deceive users. For instance, the status bar shows the linked URL when the mouse point hovers over a hyperlink; if JavaScript alters the URL, users will be misled. For example:&nbsp;&nbsp; <br>
      <blockquote><b><span class="courier">&lt;html&gt;</span><br>
          <span class="courier">&nbsp; &lt;head&gt;</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp; &lt;script type="text/javascript"&gt;</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; window.onload = function() {</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; document.getElementById('link').onmouseover = function() {</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; window.defaultStatus = 'http://openhome.cc';</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp; &lt;/script&gt;</span><br>
          <span class="courier">&nbsp; &lt;/head&gt;</span><br>
          <span class="courier">&nbsp; &lt;body&gt;</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;a id="link" href="http://caterpillar.onlyfun.net"&gt;caterpillar&lt;/a&gt;</span><br>
          <span class="courier">&nbsp; &lt;/body&gt;</span><br>
          <span class="courier">&lt;/html&gt;</span><br>
        </b></blockquote>
      Some browsers have discarded the <span class="courier">defaultStatus</span> property; but Internet Explorer still allows it. Nevertheless, when the mouse point hovers over a hyperlink, the status bar shows the URL even in Internet Explorer because of security constraint; only if the mouse point leaves the hyperlink, the <span
        class="courier">defaultStatus</span> text is shown. The status bar has security concern, so some modern browsers don't include a status bar, such as Firefox 4, IE9, Chrome, etc. <br>
      <br>
      JavaScript can open a new window; but the opened window has minimum size limitation. This is a natural and right consideration. Users won't notice the opened window if it's too small; the invisible window could be used to execute malicious code. <br>
      <br>
      Due to security considerations, if the <span class="courier">type</span> attribute of the <span
        class="courier">input</span> element is <span class="courier">"file"</span>, browsers will ignore the <span
        class="courier">value</span> attribute; even it's assigned by JavaScript. Users must choose a file by their own hand.<br>
      <br>
      Then, how to clear the selected file just one click on a button? Using JavaScript to set the value attribute an empty string is useless; the basic idea is to ask the browser to create a new file input element. For example:&nbsp; <br>
      <ul>
        <li><a href="samples/SecurityConstraint-1.html">SecurityConstraint-1.html</a></li>
      </ul>
      <pre>&lt;html&gt;
  &lt;head&gt;
    &lt;script type="text/javascript"&gt;
        window.onload = function() {
            document.getElementById('clear').onclick = function() {
                var fileupload = document.getElementById('fileupload');
                fileupload.innerHTML = fileupload.innerHTML;
            };
        };
    &lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
      &lt;div id="fileupload"&gt;&lt;input name="upload" type="file"&gt;&lt;/div&gt;
      &lt;button id="clear"&gt;Clear&lt;/button&gt;
  &lt;/body&gt;
&lt;/html&gt;<br></pre>
      <br>
      In the above example, if you select a file and click the Clear button, the <span
        class="courier">fileupload.innerHTML</span> will be <span class="courier">'&lt;input name="upload" type="file" value="..."&gt;'</span>. When you assign it back to <span
        class="courier">fileupload.innerHTML</span>, browsers will parse the HTML and ignore the value property; a new element for <span
        class="courier">'&lt;input name="upload" type="file"&gt;'</span> will be created. From users' point of view, the display looks like clearing the content of the <span
        class="courier">input</span> element. <br>
      <br>
      As another example, you can use <span class="courier">files.item(0).size</span> to get the file size in Firefox and Chrome. For example:&nbsp; <br>
      <ul>
        <li><a href="samples/SecurityConstraint-2.html">SecurityConstraint-2.html</a></li>
      </ul>
      <pre>&lt;html&gt;
  &lt;head&gt;
    &lt;script type="text/javascript"&gt;
        window.onload = function() {
            document.getElementById('size').onclick = function() {
                var size = document.getElementById('upload')
                                   .files.item(0).size;
                document.getElementById('console')
                        .innerHTML = 'Size: ' + size;
            };
        };
    &lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
      &lt;input id="upload" name="upload" type="file"&gt;&lt;br&gt;
      &lt;button id="size"&gt;Size&lt;/button&gt;&lt;br&gt;
      &lt;span id="console"&gt;&lt;/span&gt;
  &lt;/body&gt;
&lt;/html&gt;<br></pre>
      <br>
      In Internet Explorer, you cannot use the above method, but in the past (Internet Explorer 6 or before), you can create the <span
        class="courier">Image</span> or <span class="courier">ActiveXObject </span>(<span
        class="courier">Scripting.FileSystemObject</span>) instance to get the file size. Because of security concern, however, they don't work in the new version of Internet Explorer. Take creating the Image instance for example. In the past, you can...<br>
      <blockquote><strong><span class="courier">&lt;html&gt;</span><br>
          <span class="courier">&nbsp; &lt;head&gt;</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp; &lt;script type="text/javascript"&gt;</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; window.onload = function() {</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; document.getElementById('size').onclick = function() {</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var img = new Image();</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; img.onload = function() {</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var size = this.fileSize;</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; document.getElementById('console')</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .innerHTML = 'Size: ' + size;</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; img.src = document.getElementById('upload').value;</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp; &lt;/script&gt;</span><br>
          <span class="courier">&nbsp; &lt;/head&gt;</span><br>
          <span class="courier">&nbsp; &lt;body&gt;</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;input id="upload" name="upload" type="file"&gt;&lt;br&gt;</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;button id="size"&gt;Size&lt;/button&gt;&lt;br&gt;</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;span id="console"&gt;&lt;/span&gt;</span><br>
          <span class="courier">&nbsp; &lt;/body&gt;</span><br>
          <span class="courier">&lt;/html&gt;</span></strong><br>
        <span class="courier"></span></blockquote>
      The above way doesn't work now. This way, actually, is downloading the specified file. If it's allowed, one can specify any file in the client, load it into the <span
        class="courier">Image </span>instance and upload to a server. In Internet Explorer, there's no ready-made solution to get the file size. You can just use Flash or else for instead. <br>
      <br>
      A similar restriction is happening on the <span class="courier">iframe</span> element. For example:&nbsp;&nbsp; <br>
      <ul>
        <li><a href="samples/SecurityConstraint-3.html">SecurityConstraint-3.html</a></li>
      </ul>
      <pre>&lt;html&gt;
    &lt;head&gt;
        &lt;script type="text/javascript"&gt;
            window.onload = function() {
                alert(window.frames['page'].document.body.innerHTML);
            };
        &lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;iframe id="page" name="page" 
                src="http://caterpillar.onlyfun.net"&gt;&lt;/iframe&gt;
    &lt;/body&gt;
&lt;/html&gt;<br></pre>
      <br>
      You can use JavaScript to get the page content loaded by the <span
        class="courier">iframe</span> element but the page must have the same origin as this document. Without this limitation, one can specify the <span
        class="courier">src</span> attribute an URL of your intranet, get the content of the <span
        class="courier">iframe</span> element and upload it to a server. That is; I can steal the content located in your intranet. <br>
      <br>
      If you use Ajax, the asynchronous object has the same limitation. It can get another page only if the page has the same origin as the document making asynchronous requests; pages from different origin are not available. <br>
      <br>
      This is called the same origin policy. The same origin means that; two documents come from the same domain name, application layer protocol, and port number. Only if one document has the same origin as the document running the script, the asynchronous request can retrieve its content. If any one of the domain name, protocol and port number is different, the content is not available. For example, if the origin of the current document is http://openhome.cc:80/Gossip/demo.html, the following documents are considered as different origins.<br>
      <ul>
        <li>https://openhome.cc:80/Gossip/demo.html (different protocol)</li>
        <li>http://caterpillar.onlyfun.net:80/Gossip/demo.html (different domain name, even it's hosted on the same machine)</li>
        <li>http://192.168.0.1:80/Gossip/demo.html (viewed as a different domain name)</li>
        <li>http://openhome.cc:8080/Gossip/demo.html (different port number)</li>
      </ul>
      You can specify the <span class="courier">src</span> attribute of the <span
        class="courier">script</span> element an external URL. The js files from different sites can run in the same document, and use each other's variable or function; but the scripts can only get the content which has the same origin as the document running the script, not that of the js files. <br>
      <br>
      A page may change its own origin with some limitations. The <span
        class="courier">document.domain</span> returns the domain name that the current document is loaded from. For instance, the <span
        class="courier">document.domain</span> of the page "http://doc.openhome.cc:80/Gossip/demo.html" is <span
        class="courier">'doc.openhome.cc'</span>. By default, you cannot use JavaScript – no matter through <span
        class="courier">iframe</span> or Ajax – to retrieve the content from "ooo.openhome.cc", "xxx.openhome.cc", etc. If you set <span
        class="courier">document.domain</span> to <span class="courier">'openhome.cc'</span>, the shorter domain is used for subsequent origin checks. That is; documents coming from "ooo.openhome.cc", "xxx.openhome.cc" will be viewed as the same origin. But pay attention! You can only specify <span
        class="courier">document.domain</span> a suffix of the current domain. <br>
      <br>
      The above are some common security issues of JavaScript. Of course, there are more not mentioned; even some of them are not limited by browsers but prohibited by anti-virus software or firewall.<br>
      <br>
      <br>
      <p></p>
      <p></p>
      <ul>
      </ul>
    </div>
    <div class="aside">
      <script type="text/javascript"><!--
google_ad_client = "pub-9750319131714390";
google_ad_width = 160;
google_ad_height = 600;
google_ad_format = "160x600_as";
google_ad_type = "text_image";
google_ad_channel = "";
//-->
      </script>
      <script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script> <br>
      <br>
      <script type="text/javascript"><!--
google_ad_client = "pub-9750319131714390";
google_ad_width = 160;
google_ad_height = 600;
google_ad_format = "160x600_as";
google_ad_type = "text_image";
google_ad_channel = "";
//-->
      </script>
      <script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script> <br>
      <br>
      <script type="text/javascript"><!--
google_ad_client = "pub-9750319131714390";
google_ad_width = 160;
google_ad_height = 600;
google_ad_format = "160x600_as";
google_ad_type = "text_image";
google_ad_channel = "";
//-->
      </script>
      <script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script> <br>
      <br>
      <br>
    </div>
    <script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script> <script type="text/javascript">
_uacct = "UA-143766-1";
urchinTracker();
</script> </body>
</html>
