<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html dir="ltr" lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Closures</title>
    <meta content="caterpillar" name="author">
    <meta content="JavaScript closure free-variable" name="keywords">
    <link href="css/std.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <div class="header">
      <div class="hgroup">
        <h3><a href="http://openhome.cc/eGossip/">From eGossip@Openhome</a></h3>
        <h1><a href="index.html">JavaScript Essence: Closures<br>
          </a></h1>
      </div>
    </div>
    <div class="article">
      <div align="right"><a href="../../Gossip/JavaScript/Closure.html">中文</a><br>
      </div>
      <br>
      A closure is an expression that has <strong>free variables</strong>. The actual role of a free variable depends on the lexical environment. Programming languages that support closures usually support first-class functions. <strong>Creating a function is not equivalent to creating a closure.</strong> If free variables of a function have been bound to the lexical environment, it's a so-called closure.<br>
      <br>
      Then what's a free variable? Free variables are not local variables or parameters in a function. Like local variables or parameters, the scope of a free variable is basically defined in a function. It's a bound variable. For example: <br>
      <table class="cmd">
        <tbody>
          <tr>
            <td><strong>js&gt; function doSome() {<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; var x = 10;<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; function f(y) {<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return x + y;<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; return f;<br>
                &nbsp; &gt; }<br>
                js&gt; var foo = doSome();<br>
                js&gt; foo(20);</strong><br>
              30<br>
              <strong>js&gt; foo(30);</strong><br>
              40<br>
              <strong>js&gt;</strong><br>
            </td>
          </tr>
        </tbody>
      </table>
      <br>
      In the above example, the function <span class="courier">f</span> creates a closure. If you just look at <span
        class="courier">f</span>:<br>
      <blockquote><strong><span class="courier">function f(y) {</span><br>
          <span class="courier">&nbsp;&nbsp;&nbsp; return x + y;</span><br>
          <span class="courier">}</span><br>
        </strong></blockquote>
      It seems that the variable <span class="courier">x</span> is not defined. Actually, <span
        class="courier">x</span> is caught from the enclosing function. A closure is a function which closes (or survives) variables of the enclosing function. In the above example, the function <span
        class="courier">f</span> creates a closure because it closes the variable <span
        class="courier">x</span> into the scope of itself. If the closure object, a <span
        class="courier">Function</span> instance, is still alive, the closed variable <span
        class="courier">x</span> keeps alive. It's like that the scope of the variable <span
        class="courier">x</span> is extended.<br>
      <br>
      The <span class="courier">doSome</span> function returns a function assigned to <span
        class="courier">foo</span>. After <span class="courier">doSome</span> is executed, it seems that the life cycle of the local variable <span
        class="courier">x</span> has ended. The function <span class="courier">doSome</span>, however, creates a closure and <span
        class="courier">x</span> is closed in it. The life cycle of <span
        class="courier">x</span> is the same as that of the returned closure function. As above, the result of <span
        class="courier">foo(20)</span> is 10 + 20 because the value of the closed <span
        class="courier">x</span> is 10. Likewise, the result of <span class="courier">foo(30)</span> is 10 + 30. <br>
      <br>
      Take care here. <strong>What a closure close are variables, not values or references of those variables.</strong> The following example proves this concept:<br>
      <table class="cmd">
        <tbody>
          <tr>
            <td><strong>js&gt; function doOther() {<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; var x = 10;<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; function f(y) {<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return x + y;<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; x = 100;<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; return f;<br>
                &nbsp; &gt; }<br>
                js&gt; var foo = doOther();<br>
                js&gt; foo(20);<br>
              </strong>120<strong><br>
                js&gt; foo(30);<br>
              </strong>130<strong><br>
                js&gt;</strong><br>
            </td>
          </tr>
        </tbody>
      </table>
      <br>
      When a closure is created, it closes the variable <span class="courier">x</span>, not the value 10 (stored in <span
        class="courier">x</span>). That's why the results are 100 + 20 and 100 + 30 respectively after <span
        class="courier">doOther</span> updates the value of <span class="courier">x</span>. A closure closes a variable so you can update the value of the closed variable.<br>
      <table class="cmd">
        <tbody>
          <tr>
            <td><strong>js&gt; var sum = 0;<br>
                js&gt; [1, 2, 3, 4, 5].forEach(function(element) {<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; sum += element;<br>
                &nbsp; &gt; });<br>
                js&gt; sum;<br>
              </strong>15<strong><br>
                js&gt;</strong><br>
            </td>
          </tr>
        </tbody>
      </table>
      <br>
      You may have questions. If a closure closes a variable and extends the life cycle of it … how about this one? <br>
      <table class="cmd">
        <tbody>
          <tr>
            <td><strong>js&gt; function doOther() {<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; var x = 10;<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; function f() {<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x--;<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return x;<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; return f;<br>
                &nbsp; &gt; }<br>
                js&gt; var f1 = doOther();<br>
                js&gt; var f2 = doOther();<br>
                js&gt; f1();<br>
              </strong>9<strong><br>
                js&gt; f2();<br>
              </strong>9<strong><br>
                js&gt;</strong><br>
            </td>
          </tr>
        </tbody>
      </table>
      <br>
      In this example, <span class="courier">doOther</span> is called twice (or more). The closure <span
        class="courier">f</span> closes <span class="courier">x</span> and reduces the value by one. After calling the function <span
        class="courier">f1</span>, <span class="courier">x</span> is decreased by one so the result is 9. That's right. But why does the function <span
        class="courier">f2</span> return 9? <br>
      <br>
      In fact, the results of these two examples are consistent results. Variables closed by a closure are from the enclosing scope. In the above example, when the first time <span
        class="courier">doOther</span> is called, it defines a variable <span
        class="courier">x</span>, specifies it 10 and creates a closure to close it. When <span
        class="courier">doOther</span> is called again, it defines <span
        class="courier">x</span>, specifies it 10 and creates a closure to close it, too. Closures referred by <span
        class="courier">f1</span> and <span class="courier">f2</span> actually close respective <span
        class="courier">x</span> from different scope<span class="courier"></span>. Therefore, after calling <span
        class="courier">f2</span>, the return value is still 9.<br>
      <br>
      The following is a similar example:<br>
      <table class="cmd">
        <tbody>
          <tr>
            <td><strong>js&gt; function doSome(x) {<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp; return function(a) {<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return x + a;<br>
                &nbsp; &gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br>
                &nbsp; &gt; }<br>
                js&gt; var f1 = doSome(100);<br>
                js&gt; var f2 = doSome(200);<br>
                js&gt; f1(10);<br>
              </strong>110<strong><br>
                js&gt; f2(10);<br>
              </strong>210<strong><br>
                js&gt;</strong><br>
            </td>
          </tr>
        </tbody>
      </table>
      <br>
      Closures are very useful. For example, a closure can bind a prime table without creating it repetitively. <br>
      <ul>
        <li>factor.js</li>
      </ul>
      <pre>function prepareFactor(max) {
     var prime = new Array(max + 1);
     for(var i = 2; i * i &lt;= max; i++) {
         if(prime[i] == undefined) {
             for(var j = 2 * i; j &lt;= max; j++) {
                 if(j % i == 0) {
                     prime[j] = 1;
                 }
             }
         }
     }
<strong>     var primes = [];</strong>
     for(var i = 2; i &lt;= max; i++) {
         if(prime[i] == undefined) {
             primes.push(i);
         }
     }
<strong>     // factor will close primes</strong>
     function factor(num) {
         var list = [];
         for(var i = 0; primes[i] * primes[i] &lt;= num;) {
             if(num % primes[i] == 0) {
                 list.push(primes[i]);
                 num /= primes[i];
             }
             else {
                 i++
             }
         }
         list.push(num);
         return list;
     }
     return factor;
}<br></pre>
      <br>
      The variable <span class="courier">primes</span> is closed by a closure so the referred object is also available. You can use it as follows:<br>
      <table class="cmd">
        <tbody>
          <tr>
            <td><strong>js&gt; load('factor.js');<br>
                js&gt; factor = prepareFactor(1000);<br>
              </strong>function factor(num) {<br>
              &nbsp;&nbsp;&nbsp; var list = [];<br>
              &nbsp;&nbsp;&nbsp; for (var i = 0; primes[i] * primes[i] &lt;= num; ) {<br>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (num % primes[i] == 0) {<br>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list.push(primes[i]);<br>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; num /= primes[i];<br>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<br>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i++;<br>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
              &nbsp;&nbsp;&nbsp; }<br>
              &nbsp;&nbsp;&nbsp; list.push(num);<br>
              &nbsp;&nbsp;&nbsp; return list;<br>
              }<br>
              <strong><br>
                js&gt; factor(100);<br>
              </strong>2,2,5,5<strong><br>
                js&gt; factor(200);<br>
              </strong>2,2,2,5,5<strong><br>
                js&gt;</strong><br>
            </td>
          </tr>
        </tbody>
      </table>
      <br>
      A closure can also be used to simulate private accessibility of an object, management of namespace and so on. I'll talk more afterward.<br>
      <br>
      <br>
      <p></p>
      <p></p>
      <ul>
      </ul>
    </div>
    <div class="aside">
      <script type="text/javascript"><!--
google_ad_client = "pub-9750319131714390";
google_ad_width = 160;
google_ad_height = 600;
google_ad_format = "160x600_as";
google_ad_type = "text_image";
google_ad_channel = "";
//-->
      </script>
      <script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script> <br>
      <br>
      <script type="text/javascript"><!--
google_ad_client = "pub-9750319131714390";
google_ad_width = 160;
google_ad_height = 600;
google_ad_format = "160x600_as";
google_ad_type = "text_image";
google_ad_channel = "";
//-->
      </script>
      <script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script> <br>
      <br>
      <script type="text/javascript"><!--
google_ad_client = "pub-9750319131714390";
google_ad_width = 160;
google_ad_height = 600;
google_ad_format = "160x600_as";
google_ad_type = "text_image";
google_ad_channel = "";
//-->
      </script>
      <script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script> <br>
      <br>
      <br>
    </div>
    <script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script> <script type="text/javascript">
_uacct = "UA-143766-1";
urchinTracker();
</script> </body>
</html>
