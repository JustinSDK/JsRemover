<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html dir="ltr" lang="en">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <title>Dealing with XML</title>
    <meta content="caterpillar" name="author">
    <meta content="JavaScript" name="keywords">
    <link href="css/std.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <div class="header">
      <div class="hgroup">
        <h3><a href="http://openhome.cc/eGossip/">From eGossip@Openhome</a></h3>
        <h1><a href="index.html">JavaScript Essence: Dealing with XML</a></h1>
      </div>
    </div>
    <div class="article">
      <div style="text-align: right;"><a href="../../Gossip/JavaScript/XML.html">中文</a></div>
      <br>
      When using asynchronous objects to transfer complex structured data, you can use XML. Transferring XML only needs to organize data into a string composed of XML format, use <span
        class="courier">'POST'</span> when calling the <span class="courier">open</span> function, set the <span
        class="courier">'Content-Type'</span> header as <span class="courier">'text/xml'</span>, and pass the XML string to the <span
        class="courier">send</span> function. The XML string will be put in the POST body when sending. For example:<br>
      <div class="courier" style="margin-left: 40px;"><span><strong>function toXML(data) {</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp; var xml = ['&lt;data&gt;'];</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp; for(var name in data) {</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xml.push('&lt;' + name + '&gt;');</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xml.push(data[name]);</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xml.push('&lt;/' + name + '&gt;');</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp; }</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp; xml.push('&lt;/data&gt;');</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp; return xml.join('');</strong></span><span><strong><br>
          </strong></span><span><strong>}</strong></span><span><strong><br>
          </strong></span><span><strong><br>
          </strong></span><span><strong>...</strong></span><span><strong><br>
          </strong></span><span><strong>var data = { // data is actually provided by a user. </strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp; x : 10,</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp; y : 20,</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp; z : 30</strong></span><span><strong><br>
          </strong></span><span><strong>};</strong></span><span><strong><br>
          </strong></span><span><strong>var request = xhr(); // xhr() returns an asynchronous object.</strong></span><span><strong><br>
          </strong></span><span><strong>request.onreadystatechange = handleStateChange; // handleStateChange refers to a functi</strong></span><span><strong>on.</strong></span><span><strong><br>
          </strong></span><span><strong>request.open('POST', url);</strong></span><span><strong><br>
          </strong></span><span><strong>request.setRequestHeader('Content-Type', 'text/xml');</strong></span><span><strong><br>
          </strong></span><span><strong>request.send(toXML(data));</strong></span><strong><br>
        </strong></div>
      <br>
      After running the above example, the server will receive the following XML string (formatted for readability).<br>
      <div class="courier" style="margin-left: 40px;"><span><strong>&lt;data&gt;</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp; &lt;x&gt;10&lt;/x&gt;</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp; &lt;y&gt;20&lt;/y&gt;</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp; &lt;z&gt;30&lt;/z&gt;</strong></span><span><strong><br>
          </strong></span><span><strong>&lt;/data&gt;</strong></span></div>
      <br>
      Of course, the server should parse the XML string and dig out what it needs for processing. Here, I don't want to involve into how the server parses the XML string. <br>
      <br>
      When a server send a XML response, the client can use the asynchronous object's <span
        class="courier">responseXML</span> property to get the parsed DOM object, and then use DOM API to dig out what it needs for processing. For instance, the first example of <a
        href="GET.html">Making GET Requests</a> sets the returned XML string to the <span
        class="courier">div</span> element's <span class="courier">innerHTML</span>. This way limits the client's page design. The server can use a XML response to give the client free with page design. <br>
      <br>
      For example, if the server sends the following XML (Note that, the server should set the response header <span
        class="courier">'Content-Type'</span> as <span class="courier">'text/xml'</span>. If the XML contains non-ASCII characters, like Traditional Chinese characters, the <span
        class="courier">charset</span> property is also required.): <br>
      <div class="courier" style="margin-left: 40px;"><strong><span>&lt;?xml version="1.0" encoding="</span></strong><strong><span>utf-8</span></strong><strong><span>"?&gt;</span></strong><strong><span><br>
          </span></strong><strong><span>&lt;select&gt;</span></strong><strong><span><br>
          </span></strong><strong><span>&nbsp;&nbsp;&nbsp; &lt;option value="algorithm"&gt;Algorithm&lt;/option&gt;</span></strong><strong><span><br>
          </span></strong><strong><span>&nbsp;&nbsp;&nbsp; &lt;option value="graphic"&gt;Computer Graphics&lt;/option&gt;</span></strong><strong><span><br>
          </span></strong><strong><span>&nbsp;&nbsp;&nbsp; &lt;option value="pattern"&gt;Design Pattern&lt;/option&gt;</span></strong><strong><span><br>
          </span></strong><strong><span>&lt;/select&gt;</span></strong><strong><span><br>
          </span></strong></div>
      <br>
      The following example rewrites the first example of Making GET Requests. This time, it deals with a XML response. <br>
      <ul>
        <li><a href="samples/XML-1.html">XML-1.html</a></li>
      </ul>
      <pre>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Strict//EN"&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta content="text/html; charset=UTF-8" http-equiv="content-type"&gt;
        &lt;script type="text/javascript"&gt;
            window.onload = function() {
                var xhr = window.XMLHttpRequest &amp;&amp; 
                      (window.location.protocol !== 'file:' 
                          || !window.ActiveXObject) ?
                       function() {
                           return new XMLHttpRequest();
                       } :
                       function() {
                          try {
                             return new ActiveXObject('Microsoft.XMLHTTP');
                          } catch(e) {
                             throw new Error('XMLHttpRequest not supported');
                          }
                       };
                
                function param(obj) {
                    var pairs = [];
                    for(var name in obj) {
                        var pair = encodeURIComponent(name) + '=' + 
                                   encodeURIComponent(obj[name]);
                        pairs.push(pair.replace('/%20/g', '+'));
                    }
                    return pairs.join('&amp;');
                }
                
                function ajax(option) {
                    option.type = option.type || 'GET';
                    option.header = option.header || {
                      'Content-Type':'application/x-www-form-urlencoded'};
                    option.callback = option.callback || function() {};
                    
                    if(!option.url) {
                        return;
                    }
                    
                    var request = xhr();
                    request.onreadystatechange = function() {
                        option.callback.call(request, request);
                    };
                    
                    var body = null;
                    var url = option.url;
                    if(option.data) {
                        if(option.type === 'POST') {
                            body = param(option.data);
                        }
                        else {
                            url = option.url + '?' + param(option.data) 
                                     + '&amp;time=' + new Date().getTime();
                        }
                    }
                    
                    request.open(option.type, url);
                    for(var name in option.header) {
                        request.setRequestHeader(
                                name, option.header[name]);
                    }
                    request.send(body);
                }
                
                document.getElementById('category').onchange = function() {
                    ajax({
                        url     : 'XML-1.php',
                        data    : {category : this.value},
                        callback: function(request) {
                            if(request.readyState === 4) {
                                if(request.status === 200) {
                                    var select = 
                                         document.createElement('select');
                                    var xml = request.responseXML;
                                    var options = 
                                         xml.getElementsByTagName('option');
                                    for(var i = 0; i &lt; options.length; i++) {
                                        var value = 
                                          options[i].getAttribute('value');
                                        // Note that, a text is also a node.
                                        var text = 
                                          options[i].firstChild.nodeValue;
                                        if(navigator.userAgent
                                            .indexOf('MSIE') === -1) {
                                            select.add(
                                             new Option(text, value), 
                                              select.options[
                                               select.options.length]);
                                        }
                                        else {
                                            select.add(
                                              new Option(text, value),
                                               select.options.length);
                                        }
                                    }
                                    var book = 
                                      document.getElementById('book');
                                    if(book.firstChild) {
                                        book.removeChild(book.firstChild);
                                    }
                                    book.appendChild(select);
                                }
                            }
                        }
                    });
                };
            };
        &lt;/script&gt;        
    &lt;/head&gt;
    &lt;body&gt;
        Book: &lt;br&gt;
        &lt;select id="category"&gt;
            &lt;option&gt;-- Category --&lt;/option&gt;
            &lt;option value="theory"&gt;Theory&lt;/option&gt;
            &lt;option value="language"&gt;Language&lt;/option&gt;
            &lt;option value="web"&gt;Web&lt;/option&gt;
        &lt;/select&gt;&lt;br&gt;&lt;br&gt;
        Buy: &lt;div id="book"&gt;&lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre>
      <br>
      This example has the same functionality as the first example of <a
        href="GET.html">Making GET Requests</a>, yet the client can determine how to display the XML response. <br>
      <br>
      The above example also demonstrates how to deal with the difference between standards-compliant browsers and Internet Explorer when appending <span
        class="courier">option</span> elements to the <span class="courier">select</span> element. We can't use object detection here, because standards-compliant browser and Internet Explorer both have an <span
        class="courier">add</span> function. Their difference is the second parameter. Standards-compliant browsers need an existing option, and the new option will be appended after that. Internet Explorer needs an existing option's index, and the new option will be appended after it. <br>
      <br>
      Use object detection when possible. Here we can't do that, so use browser sniffing instead.<br>
      <br>
      <p></p>
      <p></p>
      <ul>
      </ul>
    </div>
    <div class="aside">
      
       <br>
      <br>
      
       <br>
      <br>
      
       <br>
      <br>
      <br>
    </div>
      </body>
</html>
