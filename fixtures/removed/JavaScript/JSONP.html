<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html dir="ltr" lang="en">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <title>Function Declarations</title>
    <meta content="caterpillar" name="author">
    <meta content="JavaScript function arguments" name="keywords">
    <link href="css/std.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <div class="header">
      <div class="hgroup">
        <h3><a href="http://openhome.cc/eGossip/">From eGossip@Openhome</a></h3>
        <h1><a href="index.html">JavaScript Essence: Using JSONP<br>
          </a></h1>
      </div>
    </div>
    <div class="article">
      <div style="text-align: right;"><a href="../../Gossip/JavaScript/JSONP.html">中文</a></div>
      <br>
      In fact, using asynchronous objects isn't the only way to send asynchronous requests. Using <span
        class="courier">iframe</span> is an example; creating an <span
        class="courier">img</span> element and setting the <span class="courier">src</span> property makes browsers request the image; creating a <span
        class="courier">script</span> element and setting the <span class="courier">src</span> property is also workable. <br>
      <br>
      You can dynamically create a <span class="courier">script</span> element, set the <span
        class="courier">src</span> property, and append it to the DOM tree, so that the browser will download the specified <span
        class="courier">script</span> for you. For example:&nbsp; <br>
      <div class="courier" style="margin-left: 40px;"><span><strong>var script = document.createElement('script');</strong></span><span><strong><br>
          </strong></span><span><strong>script.type = 'text/javascript';</strong></span><span><strong><br>
          </strong></span><span><strong>script.src = 'some.js';</strong></span><span><strong><br>
          </strong></span><span><strong>document.getElementsByTagName('head')[0].appendChild(script);</strong></span></div>
      <br>
      The above code has the same effect as writing the follow markup in the <span
        class="courier">head</span> section in the page: <br>
      <div class="courier" style="margin-left: 40px;"><span><strong>&lt;script type="text/javascript" src="some.js"&gt;&lt;/script&gt;</strong></span></div>
      <br>
      That's to say, browsers will execute the downloaded some.js. This is also a workable way to load JavaScript dynamically, and the basis of JSONP.<br>
      <br>
      As we've seen in <a href="Security.html">Security</a>, JavaScript doesn't allow getting data from different origin. Asynchronous objects also need to comply with the same origin policy. It's common, however, to request data from a server in a different domain. If there's no way to do this, many sites can't provide their cross-site services. <br>
      <br>
      The way to against this odd is using the way we've seen previously about downloading script dynamically. For example, if the current page has defined the following function:<br>
      <div class="courier" style="margin-left: 40px;"><span><strong>function doSomething(json) {</strong></span><span><strong><br>
          </strong></span><span><strong>&nbsp;&nbsp;&nbsp; ...</strong></span><span><strong><br>
          </strong></span><span><strong>}</strong></span></div>
      <br>
      If you download script dynamically as mentioned previously, and the downloaded code includes the following: <br>
      <div style="margin-left: 40px;"><strong><span class="courier">doSomething({"name":"Justin","age":35});</span></strong><strong></strong></div>
      <br>
      Then, browsers will use <span class="courier">{"name": "Justin", "age": 35}</span> - an object literal - to call the <span
        class="courier">doSomething</span> function. This is the basis of JSONP. JSONP stands for "JSON with padding". That is, JSON data with a prefix padding. The padding is typically the name of a callback function. <br>
      <br>
      If the server's acceptable request parameters are as follows:<br>
      <div class="courier" style="margin-left: 40px;"><strong><span class="courier">id=E123456&amp;</span><span
            class="bold_red">jsoncallback=handler</span></strong><span><br>
        </span></div>
      <br>
      The padding - the name of the callback function - is decided by a request parameter. If the request parameter is <span
        class="courier">jsoncallback=handler</span>, the server returns the following:<br>
      <div class="courier" style="margin-left: 40px;"><span><strong>handler({"name":"Justin","age":35});</strong></span></div>
      <br>
      Then, the client has more flexibility to decide which callback function is used to process the returned JSON. The following is a realistic example. You can open this page in the localhost and type an id to retrieve data. <br>
      <ul>
        <li><a href="samples/JSONP-1.html">JSONP-1.html</a></li>
      </ul>
      <pre>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Strict//EN"&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta content="text/html; charset=UTF-8" http-equiv="content-type"&gt;
        &lt;script type="text/javascript" src="js/json2.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript"&gt;
            window.onload = function() {
                function param(obj) {
                    var pairs = [];
                    for(var name in obj) {
                        var pair = encodeURIComponent(name) + '=' + 
                                   encodeURIComponent(obj[name]);
                        pairs.push(pair.replace('/%20/g', '+'));
                    }
                    return pairs.join('&amp;');
                }
                
                function getScript(url, callback) {
                    var script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = url;
                    
                    // Cross-browser processing events when download script is completed
                    script.onload = script.onreadystatechange = function() {
                        if (!this.readyState ||
                            this.readyState === "loaded" || 
                            this.readyState === "complete") {
                            this.onload = this.onreadystatechange = null;
                            document.getElementsByTagName('head')[0]
                                    .removeChild(this);
                            callback();
                        }
                    };
                    
                    document.getElementsByTagName('head')[0]
                            .appendChild(script);
                }
                
                function jsonp(option, callbackName) {
                    if(!option.url || !callbackName) {
                        return;
                    }
                    var data = option.data || {};
                    
                    // create a temporary function
                    data[callbackName] = 'XD' + jsonp.jsc++;
                    window[data[callbackName]] = function(json) {
                        option.callback(json);
                    };
                    var url = option.url + '?' + param(data);
                    
                    // download the script
                    getScript(url, function() {
                         // remove the temporary function 
                         // when the script is downloaded and executed
                         window[data[callbackName]] = undefined;
                         try {
                             delete window[data[callbackName]];
                         }
                         catch(e) {}
                    });
                }
                jsonp.jsc = new Date().getTime();
                
                document.getElementById('test').onclick = function() {
                    jsonp({
                        url      : 'http://openhome.cc/eGossip/' +
                                   'JavaScript/samples/JSONP-1.php',
                        data     : {
                            id   : document.getElementById('id').value,
                        },
                        callback : function(person) {
                            document.getElementById('result').innerHTML = 
                                person.name + ',' + person.age;
                        }
                    }, 'jsoncallback');
                };
            };
        &lt;/script&gt;        
    &lt;/head&gt;
    &lt;body&gt;
        ID：&lt;input id="id"&gt;
        &lt;button id="test"&gt;Test JSONP&lt;/button&gt;
        &lt;span id="result"&gt;&lt;/span&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre>
      <br>
      The URL <a href="http://api.flickr.com/services/feeds/photos_public.gne">http://api.flickr.com/services/feeds/photos_public.gne</a> provides a service through JSONP. You can use the <span
        class="courier">jsoncallback</span> parameter to specify a callback function. The following example uses a tag to search images on Filick, and display them in the page.<br>
      <ul>
        <li><a href="samples/JSONP-2.html">JSONP-2.html</a></li>
      </ul>
      <pre>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Strict//EN"&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta content="text/html; charset=UTF-8" http-equiv="content-type"&gt;
        &lt;script type="text/javascript" src="js/json2.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript"&gt;
            window.onload = function() {
                function param(obj) {
                    var pairs = [];
                    for(var name in obj) {
                        var pair = encodeURIComponent(name) + '=' + 
                                   encodeURIComponent(obj[name]);
                        pairs.push(pair.replace('/%20/g', '+'));
                    }
                    return pairs.join('&amp;');
                }
                
                function getScript(url, callback) {
                    var script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = url;
                    
                    script.onload = script.onreadystatechange = function() {
                        if (!this.readyState ||
                            this.readyState === "loaded" || 
                            this.readyState === "complete") {
                            this.onload = this.onreadystatechange = null;
                            document.getElementsByTagName('head')[0]
                                    .removeChild(this);
                            callback();
                        }
                    };
                    
                    document.getElementsByTagName('head')[0]
                            .appendChild(script);
                }
                
                function jsonp(option, callbackName) {
                    if(!option.url || !callbackName) {
                        return;
                    }
                    var data = option.data || {};
                    
                    data[callbackName] = 'XD' + jsonp.jsc++;
                    window[data[callbackName]] = function(json) {
                        option.callback(json);
                    };
                    var url = option.url + '?' + param(data);
                    
                    getScript(url, function() {
                         window[data[callbackName]] = undefined;
                         try {
                             delete window[data[callbackName]];
                         }
                         catch(e) {}
                    });
                }
                jsonp.jsc = new Date().getTime();
                
                document.getElementById('search').onclick = function() {
                    jsonp({
                        url      : 'http://api.flickr.com/services/' + 
                                   'feeds/photos_public.gne',
                        data     : {
                            tagmode : 'any',
                            format  : 'json',
                            tags    : document.getElementById('tags').value
                        },
                        callback : function(data) {
                            var images = document.getElementById('images');
                            // empty all images
                            var length = images.childNodes.length;
                            for(var i = 0; i &lt; length; i++) {
                                images.removeChild(images.firstChild);
                            }
                            // Flick retusn JSNOP. You can observe its data format.
                            // items is an array. Every element has a media property.
                            // the m property of media is the image's url.
                            var items = data.items;
                            for(var i = 0; i &lt; items.length; i++) {
                                var img = document.createElement('img');
                                img.src = items[i].media.m;
                                images.appendChild(img);
                            }
                        }
                    }, 'jsoncallback');
                };
            };
        &lt;/script&gt;        
    &lt;/head&gt;
    &lt;body&gt;
    	&lt;input id="tags"&gt;&lt;br&gt;
		&lt;button id="search"&gt;Search&lt;/button&gt;
    	&lt;div id="images"&gt;&lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre>
      <br>
      <br>
      <br>
      <p></p>
      <p></p>
      <ul>
      </ul>
    </div>
    <div class="aside">
      
       <br>
      <br>
      
       <br>
      <br>
      
       <br>
      <br>
      <br>
    </div>
      </body>
</html>
