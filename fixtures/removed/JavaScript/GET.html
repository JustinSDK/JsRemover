<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html dir="ltr" lang="en">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <title>Making GET Requests</title>
    <meta content="caterpillar" name="author">
    <meta content="JavaScript" name="keywords">
    <link href="css/std.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <div class="header">
      <div class="hgroup">
        <h3><a href="http://openhome.cc/eGossip/">From eGossip@Openhome</a></h3>
        <h1><a href="index.html">JavaScript Essence: Making GET Requests<br>
          </a></h1>
      </div>
    </div>
    <div class="article">
      <div style="text-align: right;"><a href="../../Gossip/JavaScript/GET.html">中文</a></div>
      <br>
      <a href="http://www.w3.org/Protocols/rfc2616/rfc2616.html">HTTP</a> defines GET as retrieving information from the Request-URI. GET is also a <a
        href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html">idempotent method</a>. That's to say, the results of identical GET requests are the same as that of a single request. Because GET is used to retrieve information, it doesn't alter the server state. <br>
      <br>
      When using GET to submit a traditional form, the request parameters are shown in the location bar and the page is refreshed. If using asynchronous objects to do a GET request, the request parameters aren't shown in the location bar, so users can't save request parameters in their bookmark directly. <br>
      <br>
      When using an asynchronous object to send a GET request with parameters, the query string is appended to the second <span
        class="courier">url</span> argument of <span class="courier">open</span>, and then the <span
        class="courier">send</span> function is called with a <span class="courier">null</span> argument. An example is as follow: <br>
      <ul>
        <li><a href="samples/GET-1.html">GET-1.html</a></li>
      </ul>
      <pre>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Strict//EN"&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta content="text/html; charset=UTF-8" http-equiv="content-type"&gt;
        &lt;script type="text/javascript"&gt;
            window.onload = function() {
                var xhr = window.XMLHttpRequest &amp;&amp; 
                      (window.location.protocol !== 'file:' 
                          || !window.ActiveXObject) ?
                       function() {
                           return new XMLHttpRequest();
                       } :
                       function() {
                          try {
                             return new ActiveXObject('Microsoft.XMLHTTP');
                          } catch(e) {
                             throw new Error('XMLHttpRequest not supported');
                          }
                       };
                       
                document.getElementById('category').onchange = function() {
                    var request = xhr();
                    request.onreadystatechange = function() {
                        if(request.readyState === 4) {
                            if(request.status === 200) {
                                document.getElementById('book').innerHTML = 
                                    request.responseText;
                            }
                        }
                    };
                    request.open('GET', 'GET-1.php?category=' + this.value + 
                         '&amp;time=' + new Date().getTime()); // Avoid caching a GET request
                    request.send(null);
                };
            };
        &lt;/script&gt;        
    &lt;/head&gt;
    &lt;body&gt;
        Book: &lt;br&gt;
        &lt;select id="category"&gt;
            &lt;option&gt;-- Category --&lt;/option&gt;
            &lt;option value="theory"&gt;Theory&lt;/option&gt;
            &lt;option value="language"&gt;Language&lt;/option&gt;
            &lt;option value="web"&gt;Web&lt;/option&gt;
        &lt;/select&gt;&lt;br&gt;&lt;br&gt;
        Buy: &lt;div id="book"&gt;&lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre>
      <br>
      The above example demonstrates how to implement cascading drop down lists. The items of the second drop down list depend on the selected item of the first one. We don't hard code items of the second drop down list, yet generate them according to the request parameter of the first one. For example, if the request parameter is <span
        class="courier">'category=theory'</span>, the returned HTML fragment is as follow: <br>
      <div class="courier" style="margin-left: 40px;"><strong><span>&lt;select&gt;</span></strong><strong><span><br>
          </span></strong><strong><span>&nbsp;&nbsp;&nbsp; &lt;option value="algorithm"&gt;Al</span></strong><strong><span>gorithm</span></strong><strong><span>&lt;/option&gt;</span></strong><strong><span><br>
          </span></strong><strong><span>&nbsp;&nbsp;&nbsp; &lt;option value="graphic"&gt;Computer Gr</span></strong><strong><span>aphics</span></strong><strong><span>&lt;/option&gt;</span></strong><strong><span><br>
          </span></strong><strong><span>&nbsp;&nbsp;&nbsp; &lt;option value="pattern"&gt;</span></strong><strong><span>Design Pattern</span></strong><strong><span>&lt;/option&gt;</span></strong><strong><span><br>
          </span></strong><strong><span>&lt;/select&gt;</span></strong></div>
      <br>
      Of course, returning a HTML fragment isn't a good way since the server limits the client's page design. This example is only demonstrating how to send a GET request. We'll see other response formats, such as XML or JSON. They give clients flexibility in dealing with their own page design. <br>
      <br>
      Another point to note is that, browsers, especially Internet Explorer, may cache a GET request if the url is the same. To avoid retrieving old data, you can append a time stamp to the url. A request with a different request won't be cached by browsers. <br>
      <br>
      In the world of the web, this is always not the end of story. When sending a GET request, you should pay attention to encoding problems. URL has several reserved words, such as <span
        class="courier">'/'</span>, <span class="courier">'?'</span>, <span
        class="courier">'@'</span>, a space character, etc. They are defined in <a
        href="http://tools.ietf.org/html/rfc3986">RFC 3986</a>. If you want to express these reserved words or non-ASCII characters, the <span
        class="courier">'%HEXHEX'</span> format should be used. For example, the url <span
        class="courier">'http://openhome.cc/add.jsp?url=http://caterpillar.onlyfun.net'</span>should be written as follow: <br>
      <div class="courier" style="margin-left: 40px;"><span><strong>http://opehome.cc/add.</strong></span><span><strong>jsp</strong></span><span><strong>?http%3A%2F%2Fcaterpillar.onlyfun.net</strong></span></div>
      <br>
      The three characters <span class="courier">'://'</span> are encoded into <span
        class="courier">'%3A%2F%2F'</span>.<br>
      <br>
      In JavaScript, the <span class="courier">encodeURIComponent</span> function is used for encoding characters. Its encoding rules comply with RFC 3986. Before RFC 3986, however, HTTP has defined encoding rules for GET and POST. Basically, the encoding format is also <span
        class="courier">'%HEXHEX'</span>, but the space character is encoded as <span
        class="courier">'+'</span>, not <span class="courier">'%20'</span> in RFC 3986. When submitting a traditional form, browsers will automatically encode request parameters according to the specified encoding of the page, and the space character is encoded as <span
        class="courier">'+'</span>. If you send request parameters through asynchronous objects, you should do encoding by yourself. <br>
      <br>
      After calling <span class="courier">encodeURIComponent</span>, you should replace <span
        class="courier">'%20'</span> with <span class="courier">'+'</span> to comply with the HTTP specification. What you should know is, JavaScript uses Unicode internally and UTF-8 is the taken implementation. So, the string passed to <span
        class="courier">encodeURIComponent</span> should be UTF-8. After sending request parameters encoded by <span
        class="courier">encodeURIComponent</span>, the server should process the received string in UTF-8. <br>
      <br>
      If asynchronous objects send a request without using <span class="courier">encodeURIComponent</span> to encode non-ASCII request parameters, like Traditional Chinese characters, how will asynchronous objects encode request parameters? This depends on browsers. So, it's suggested to use <span
        class="courier">encodeURIComponent</span>, and then replace <span
        class="courier">'%20'</span> with <span class="courier">'+'</span> before sending a request to avoid cross-browsers problems. <br>
      <br>
      The following example is another demonstration about GET. If your input conflicts with an existing bookmark (there're two existing bookmarks, <span
        class="courier">'http://caterpillar.onlyfun.net'</span> and <span
        class="courier">'http://openhome.cc'</span>), an error message will be shown. <br>
      <ul>
        <li><a href="samples/GET-2.html">GET-2.html</a></li>
      </ul>
      <pre>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Strict//EN"&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta content="text/html; charset=UTF-8" http-equiv="content-type"&gt;
        &lt;script type="text/javascript"&gt;
            window.onload = function() {
                var xhr = window.XMLHttpRequest &amp;&amp; 
                      (window.location.protocol !== 'file:' 
                          || !window.ActiveXObject) ?
                       function() {
                           return new XMLHttpRequest();
                       } :
                       function() {
                          try {
                             return new ActiveXObject('Microsoft.XMLHTTP');
                          } catch(e) {
                             throw new Error('XMLHttpRequest not supported');
                          }
                       };
                
                function param(obj) {
                    var pairs = [];
                    for(var name in obj) {
                        var pair = encodeURIComponent(name) + '=' + 
                                   encodeURIComponent(obj[name]);
                        pairs.push(pair.replace('/%20/g', '+'));
                    }
                    return pairs.join('&amp;');
                }
                
                document.getElementById('url').onblur = function() {
                    var request = xhr();
                    request.onreadystatechange = function() {
                        if(request.readyState === 4) {
                            if(request.status === 200) {
                                var message = '';
                                if(request.responseText === 'urlExisted') {
                                    message = 'URL existed';
                                }
                                document.getElementById('message')
                                        .innerHTML = message;
                            }
                        }
                    };
                    var params = param(
                       { url : document.getElementById('url').value}
                    );
                    request.open('GET', 'GET-2.php?' + params + 
                         '&amp;time=' + new Date().getTime()); // Avoid caching a GET request
                    request.send(null);
                };
            };
        &lt;/script&gt;        
    &lt;/head&gt;
    &lt;body&gt;
        Add a bookmark:&lt;br&gt;
        URL: &lt;input id="url" type="text"&gt;
        &lt;span id="message" style="color:red"&gt;&lt;/span&gt;&lt;br&gt;
        Title: &lt;input type="text"&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre>
      <br>
      If the URL already exists, a string <span class="courier">'urlExisted'</span> will be returned. The <span
        class="courier">message</span> variable will be set as <span class="courier">'URL existed'</span>.<br>
      <br>
      <br>
      <p></p>
      <p></p>
      <ul>
      </ul>
    </div>
    <div class="aside">
      
       <br>
      <br>
      
       <br>
      <br>
      
       <br>
      <br>
      <br>
    </div>
      </body>
</html>
