<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html dir="ltr" lang="en">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <title>Making POST Requests</title>
    <meta content="caterpillar" name="author">
    <meta content="JavaScript" name="keywords">
    <link href="css/std.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <div class="header">
      <div class="hgroup">
        <h3><a href="http://openhome.cc/eGossip/">From eGossip@Openhome</a></h3>
        <h1><a href="index.html">JavaScript Essence: Making POST Requests<br>
          </a></h1>
      </div>
    </div>
    <div class="article">
      <div style="text-align: right;"><a href="../../Gossip/JavaScript/POST.html">中文</a></div>
      <br>
      HTTP defines POST as posting data to the Request-URI. POST is a non-idempotent method. That is, the side-effects of N &gt; 0 identical POST requests may be different. POST may change the server's state, such as changing database content or store files on the server. <br>
      <br>
      We can send a POST request by setting <span class="courier">'POST'</span> to the first parameter of the asynchronous object's <span
        class="courier">open</span> function, and then use the <span class="courier">setRequestHeader</span> function to specify its content type. The posted data will be put in the post body of the request, so the server needs the content type information. The posted data will be the argument when calling the <span
        class="courier">send</span> function.<br>
      &nbsp;<br>
      For example, when posting form data, the <span class="courier">'Content-Type'</span> header should be <span
        class="courier">'application/x-www-form-urlencoded'</span>. The following is a demonstration. <br>
      <div class="courier" style="margin-left: 40px;"><span><strong>...</strong></span><span><strong><br>
          </strong></span><span><strong>var url = 'somewhere';</strong></span><span><strong><br>
          </strong></span><span><strong>var queryString = 'a=10&amp;b=20';</strong></span><span><strong><br>
          </strong></span><span><strong>xmlHttp.open('POST', url);</strong></span><span><strong><br>
          </strong></span><span><strong>xmlHttp.setRequestHeader('Content-Type',&nbsp; 'application/x-www-form-urlencoded');</strong></span><span><strong><br>
          </strong></span><span><strong>xmlHttp.send(queryString); </strong></span></div>
      <br>
      The data put in the post body may be other formats, such as XML or JSON. You should set respective request headers for them. I'll mention them afterword. <br>
      <br>
      The following example encapsulates several operations of asynchronous objects, and use that to rewrite the second example of <a
        href="GET.html">Making GET Requests</a>. <br>
      <ul>
        <li><a href="samples/POST-1.html">POST-1.html</a></li>
      </ul>
      <pre>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Strict//EN"&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta content="text/html; charset=UTF-8" http-equiv="content-type"&gt;
        &lt;script type="text/javascript"&gt;
            window.onload = function() {
                var xhr = window.XMLHttpRequest &amp;&amp; 
                      (window.location.protocol !== 'file:' 
                          || !window.ActiveXObject) ?
                       function() {
                           return new XMLHttpRequest();
                       } :
                       function() {
                          try {
                             return new ActiveXObject('Microsoft.XMLHTTP');
                          } catch(e) {
                             throw new Error('XMLHttpRequest not supported');
                          }
                       };
                
                function param(obj) {
                    var pairs = [];
                    for(var name in obj) {
                        var pair = encodeURIComponent(name) + '=' + 
                                   encodeURIComponent(obj[name]);
                        pairs.push(pair.replace('/%20/g', '+'));
                    }
                    return pairs.join('&amp;');
                }
                
                function ajax(option) {
                    option.type = option.type || 'GET';
                    option.header = option.header || {
                      'Content-Type':'application/x-www-form-urlencoded'};
                    option.callback = option.callback || function() {};
                    
                    if(!option.url) {
                        return;
                    }
                    
                    var request = xhr();
                    request.onreadystatechange = function() {
                        option.callback.call(request, request);
                    };
                    
                    var body = null;
                    var url = option.url;
                    if(option.data) {
                        if(option.type === 'POST') {
                            body = param(option.data);
                        }
                        else {
                            url = option.url + '?' + param(option.data) 
                                     + '&amp;time=' + new Date().getTime();
                        }
                    }
                    
                    request.open(option.type, url);
                    for(var name in option.header) {
                        request.setRequestHeader(
                                name, option.header[name]);
                    }
                    request.send(body);
                }
                
                document.getElementById('url').onblur = function() {
                    ajax({
                        type: 'POST',
                        url : 'POST-1.php',
                        data: {url : document.getElementById('url').value},
                        callback: function(request) {
                            if(request.readyState === 4) {
                                if(request.status === 200) {
                                    var message = '';
                                    if(request.responseText 
                                         === 'urlExisted') {
                                        message = 'URL existed';
                                    }
                                    document.getElementById('message')
                                        .innerHTML = message;
                                }
                            }
                        }
                    });
                };
            };
        &lt;/script&gt;        
    &lt;/head&gt;
    &lt;body&gt;
        Add a bookmark&lt;br&gt;
        URL: &lt;input id="url" type="text"&gt;
        &lt;span id="message" style="color:red"&gt;&lt;/span&gt;&lt;br&gt;
        Title: &lt;input type="text"&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre>
      <br>
      In the above example, you can pass the <span class="courier">ajax</span> function an option object. The available options are as follows:&nbsp; <br>
      <ul>
        <li><span class="courier">type</span>: Used to specify the request type. The default value is <span
            class="courier">'GET'</span>.</li>
        <li><span class="courier">url</span>: The requested URL.</li>
        <li><span class="courier">data</span>: The request parameters.</li>
        <li><span class="courier">header</span>: The request header. The default value is <span
            class="courier">'application/x-www-form-urlencoded'</span>. </li>
        <li><span class="courier">callback</span>: The callback function for different states of the asynchronous object. Its first parameter and this will be the asynchronous object. (The first parameter of the callback function referred by <span
            class="courier">onreadystatechange</span> is an event object in Firefox, but <span
            class="courier">undefined</span> in Internet Explorer. The callback function's <span
            class="courier">this</span> is the <span class="courier">XMLHttpRequest</span> instance in Firefox, but <span
            class="courier">window</span> (the global object) in Internet Explorer. We encapsulate these in-consistencies here.)</li>
      </ul>
      <br>
      <p></p>
      <p></p>
      <ul>
      </ul>
    </div>
    <div class="aside">
      
       <br>
      <br>
      
       <br>
      <br>
      
       <br>
      <br>
      <br>
    </div>
      </body>
</html>
